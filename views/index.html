<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="never">
    <meta name="description" content="download douyin video images without water mesk">
    <link rel="stylesheet" href="../static/stylesheets/milligram.min.css">
    <link rel="stylesheet" href="../static/stylesheets/progress.css">
    <link rel='stylesheet' href='../static/stylesheets/unicons.css'>
    <link rel="shortcut icon" href="../static/images/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="../static/images/favicon.ico">
    <style>
        body {
            padding: 0;
            min-width: 70%;
            font: 14px "Lucida Grande", Helvetica, Arial, sans-serif;
        }

        .tk{
            width: 40%;
            margin: 0 auto;
        }

        .video_play{
            min-width: 0;
            flex: 1 1 auto;
            position: relative;
        }

        .card {
            position: relative;
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
            -ms-flex-direction: column;
            flex-direction: column;
            min-width: 0;
            word-wrap: break-word;
            background-color: #fff;
            background-clip: border-box;
            border: 1px solid rgba(0,0,0,.125);
            border-radius: 1rem
        }

        .card-body {
            -webkit-box-flex: 1;
            -ms-flex: 1 1 auto;
            flex: 1 1 auto;
            padding: 1.25rem
        }

        .card-header:first-child {
            border-radius: calc(.25rem - 1px) calc(.25rem - 1px) 0 0
        }

        .card-header+.list-group .list-group-item:first-child {
            border-top: 0
        }

        img {
            height: auto;
            width: 100%;
        }
    </style>
    <script src="../static/javascripts/jquery.min.js"></script>
    <script src="../static/javascripts/jquery.cookie.min.js"></script>
    <script src="../static/javascripts/jszip.min.js"></script>
    <script src="../static/javascripts/FileSaver.min.js"></script>
    <script>
        $(document).ready(function(){
            $('#setcookie').click(function(){
                    if($('#cookieform').is(':hidden')){
                        $('#cookieform').show();
                    } else {
                        $('#cookieform').hide();
                    }
                })
            try {
                let seachTxt = window.location.href.split("=");
                seachTxt = decodeURI(seachTxt [1])
                if (seachTxt === 'undefined'){
                    $('#video_info').hide();
                } else {
                    //è§£ç url
                    $("#video_url").attr('value',seachTxt)
                    $('#video_info').show();
                    return 0;
                }
            } catch (error) {
                return 0;
            }
        });
    </script>
    <script>
        $(document).ready(function(){
            if (!$.cookie('dycookie')){
                alert('è¯·å…ˆå¡«å†™æŠ–éŸ³çš„cookieæ‰å¯ä»¥æ­£å¸¸è§£æä½œå“')
            } else {
                var dycookie = JSON.parse($.cookie('dycookie'));
                $('#odin_tt_Field').val(dycookie['odin_tt'])
                $('#passport_csrf_token_Field').val(dycookie['passport_csrf_token'])
                $('#sessionid_ss_Field').val(dycookie['sessionid_ss'])
                $('#ttwid_Field').val(dycookie['ttwid'])
                $('#msToken_Field').val(dycookie['msToken'])
            }
        });
    </script>
    <title>TikTokWeb</title>
</head>
<body class="bs-docs-home">
<div class="col-md-8">
    <div class="tk">
        <h1>TikTokWeb</h1>
        <blockquote>
            <p><em>å…ˆå¡«å†™ä½ çš„æŠ–éŸ³cookieï¼Œç„¶åè¾“å…¥é•¿çŸ­é“¾ç‚¹å‡»è§£æè¯•è¯•å§ğŸ‰ï¼</em></p>
        </blockquote>
        <div class="input-group input-group-lg" style="margin-bottom: 10px;">
            <input type="text" class="form-control link-input" name="è¯·è¾“å…¥é“¾æ¥" value="https://v.douyin.com/NKyY6Ch/" id="video_url">
            <div class="input-group-btn">
                <div class="btn-clear" id="btn-clear">
                    <button class="btn btn-default" type="button" value="è§£æ" id="get">è§£æ</button>
                    <button class="button button-clear" type="submit" value="è®¾ç½®Cookie" id="setcookie">è®¾ç½®Cookie</button>
                </div>
            </div>
        </div>
        <form style="display: none;" id="cookieform">
            <fieldset>
                <ul>
                    <li>
                        åªéœ€å¡«å†™cookieçš„valueï¼Œä¸éœ€è¦å¡«å†™key ğŸ˜€
                    </li>
                    <li>
                        ä¾‹å¦‚ odin_ttçš„å€¼æ˜¯718d2ae9ed49a5fd4fc1â€¦â€¦â€¦â€¦åªéœ€è¦å¡«è¿™éƒ¨åˆ†å³å¯ ğŸ¥´
                    </li>
                    <li>
                        ä½ çš„æ‰€æœ‰ä¿¡æ¯å‡å‚¨å­˜åœ¨æœ¬åœ° ğŸš¨
                    </li>
                </ul>
                <pre class="savesuccess" style="display: none;"><code>ä¿å­˜æˆåŠŸ</code></pre>
                <pre class="saveerror" style="display: none;"><code>ä¿å­˜å¤±è´¥</code></pre>
                <label for="odin_tt_Field">odin_tt</label>
                <input type="text" placeholder="odin_ttçš„å€¼" id="odin_tt_Field">
                <label for="passport_csrf_token_Field">passport_csrf_token</label>
                <input type="text" placeholder="passport_csrf_tokençš„å€¼" id="passport_csrf_token_Field">
                <label for="sessionid_ss_Field">sessionid_ss</label>
                <input type="text" placeholder="sessionid_ssçš„å€¼" id="sessionid_ss_Field">
                <label for="ttwid_Field">ttwid</label>
                <input type="text" placeholder="ttwidçš„å€¼" id="ttwid_Field">
                <label for="msToken_Field">msToken</label>
                <input type="text" placeholder="msTokençš„å€¼" id="msToken_Field">
                <button class="btn btn-default" type="button" value="ä¿å­˜" id="savecookie">ä¿å­˜</button>
                <button class="btn btn-default" type="button" value="æ¸…ç†" id="cleancookie">æ¸…ç†</button>
            </fieldset>
        </form>
        <div style="display: none;" id="video_info">
            <span>
                <div class="card">
                    <div class="card-body">
                        <div class="container">
                                <table style="overflow: auto;">
                                    <tr align="center">
                                        <td>
                                            <% if (data.type=='å›¾é›†'){%>
                                            <div class="images_play">
                                                <% for (var i = 0;i<data.images.length;i++) { %>
                                                    <img alt="<%- data.desc %>"crossorigin="anonymous" src="<%- data.images[i] %>">
                                                <%}%>
                                            </div>
                                            <%} else {%>
                                            <div class="video_play">
                                                <!--
                                                <video id="play" preload="auto" src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/396624/err.mp4" autoplay muted loop></video>
                                                -->
                                                <video controls autoplay width="50%" controls="controls" id="play" preload="auto" type="video/mp4" webkit-playsinline="true" playsinline="" x5-video-player-type="h5" x5-video-player-fullscreen="portraint">
                                                    <source src="<%= data.url %>" type="video/mp4">
                                                </video>
                                            </div>
                                            <%}%>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                        <div class="row">
                                            <table align="center" style="width: 400px;">
                                                <tr align="right">
                                                    <td style="width: 160px;"><span class="column">ç±»å‹</span></td>
                                                    <td><span class="column" id="type" style="text-align: center;display: block;"><%= data.type %></span></td>
                                                </tr>
                                                <tr align="right">
                                                    <td style="width: 160px;"><span class="column">æ–‡æ¡ˆ</span></td>
                                                    <td><span class="column" id="desc" style="text-align: center;display: block;"><%= data.desc %></span></td>
                                                </tr>
                                                <tr align="right">
                                                    <td style="width: 160px;"><span class="column">æŠ–éŸ³ID</span></td>
                                                    <td><span class="column" id="unique_id" style="text-align: center;display: block;"><%= data.unique_id %></span></td>
                                                </tr>
                                                <tr align="right">
                                                    <td style="width: 160px;"><span class="column">è§†é¢‘ID</span></td>
                                                    <td><span class="column" id="video_id" style="text-align: center;display: block;"><%= data.video_id %></span></td>
                                                </tr>
                                                <tr align="right">
                                                    <td style="width: 160px;"><span class="column">ä¸»é¡µ</span></td>
                                                    <td><a class="column" id="userhome" target="_blank" href="<%= data.userhome %>" style="text-align: center;display: block;"><%= data.nickname %></a></td>
                                                </tr>
                                            </table>
                                        </div>
                                        </td>
                                    </tr>
                                    <tr align="center">
                                        <td align="center">
                                                <% if (data.type=='å›¾é›†'){%>
                                                <button type='button' id="download" style="color: white;" rel="noreferrer" onclick="downloadall();">
                                                    ä¸‹è½½æ‰€æœ‰
                                                </button>
                                                <%} else { %>
                                                <button type='button' id="download">
                                                    <a target="_blank" style="color: white;" rel="noreferrer" href="<%= data.url %>" download="<%= data.desc %>.mp4">
                                                    ä¸‹è½½è§†é¢‘
                                                    </a>
                                                </button>
                                                <% }%>
                                            </button>
                                            &nbsp;&nbsp;&nbsp;
                                            <button id="download">
                                                <a target="_blank" style="color: white;" rel="noreferrer" href="<%= data.music %>" download="<%= data.m_title %>.mp3">
                                                    <% if(data.music=='') {%>è¯¥åŸå£°ä¸å¯ç”¨<%} else {%>ä¸‹è½½åŸå£°<%} %>
                                                </a>
                                            </button>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <span id="desc" style="text-align: center;display: block;">
                                <%= data.desc %>
                            </span>
                        </td>
                    </tr>
                    <tr align="center">
                        <td>
                            <button id="download">
                                <a target="_blank" style="color: white;" rel="noreferrer" href="<%= data.url %>" download="<%= data.desc %>.mp4">
                                ä¸‹è½½
                                </a>
                            </button>
                            <button id="copylink">
                                <a target="_blank" style="color: white;" rel="noreferrer">
                                å¤åˆ¶é“¾æ¥
                                </a>
                            </button>
                        </td>
                    </tr>
                </table>
                </div>
                </div>
            </span>
        <footer>
            <span style="text-align: center;display: block;">
            <a target="_blank" style="color: #9b4dca;" rel="noreferrer" href="https://github.com/Johnserf-Seed/TikTokWeb">
                        GitHub Â· JohnserfSeed Â· 2022
                </a>
            </span>
        </footer>
                </span>
            </footer>
        </div>
        <!-- å›åˆ°é¡¶éƒ¨-->
        <div class="progress-wrap">
            <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
                <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98"/>
            </svg>
        </div>
    </div>
</div>
<script>
    //å›¾ç‰‡è½¬base64; ä¼ å…¥å›¾ç‰‡è·¯å¾„ï¼Œè¿”å›base64
    function getBase64(img,index) {
        function getBase64Image(img, width, height) {
            var canvas = document.createElement("canvas");
            canvas.width = width ? width : img.width;
            canvas.height = height ? height : img.height;
            var ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            var dataURL = canvas.toDataURL();
            return dataURL;
        }
        var image = new Image();
        image.crossOrigin = 'Anonymous';
        image.src = img;
        /*
        * deferredå¯¹è±¡æ˜¯ä¸€ä¸ªå»¶è¿Ÿå¯¹è±¡ï¼Œæ„æ€æ˜¯å‡½æ•°å»¶è¿Ÿåˆ°æŸä¸ªç‚¹æ‰å¼€å§‹æ‰§è¡Œï¼Œæ”¹å˜æ‰§è¡ŒçŠ¶æ€çš„æ–¹æ³•æœ‰ä¸¤ä¸ªï¼ˆæˆåŠŸï¼šresolveå’Œå¤±è´¥ï¼šrejectï¼‰ï¼Œ
        * åˆ†åˆ«å¯¹åº”ä¸¤ç§æ‰§è¡Œå›è°ƒï¼ˆæˆåŠŸå›è°ƒå‡½æ•°ï¼šdoneå’Œå¤±è´¥å›è°ƒå‡½æ•°failï¼‰
        * */
        var deferred = $.Deferred();
        if (img) {
            image.onload = function () {
                // æ‰§è¡ŒæˆåŠŸå›è°ƒ
                deferred.resolve(getBase64Image(image),index);
            }
            return deferred.promise();
        }
    }
</script>

<script>
    var zip = new JSZip();
    // ä¸‹è½½æ‰€æœ‰å›¾ç‰‡
    function downloadall() {
        var strimage = '<%- data.images %>'
        var desc = '<%- data.desc %>'
        var images = [];
        var imgBase64 = {};
        images  = strimage.split(',')
        // å‹ç¼©åŒ…æ–‡ä»¶å¤¹
        var folder = zip.folder(desc);
        // è¯»å–æ‰€æœ‰å›¾ç‰‡è¿”å›base64
        for (var i = 0; i < images.length; i++) {
            getBase64(images[i],i).then(function (base64,index) {
                //imgBase64.push(base64.substring(22));  // å»æ‰base64çš„å›¾ç‰‡æ ¼å¼å‰ç¼€
                imgBase64[index] = base64.substring(22);
            }, function (err) {
                console.log(err);
            });
        };
        // å‘é€ä¸‹è½½
        function downloadZip() {
            setTimeout(function () {
                if (images.length == Object.keys(imgBase64).length) {
                    for (var i = 0; i < images.length; i++) {
                        folder.file(desc + i + ".jpg", imgBase64[i], { base64: true });
                    }
                    zip.generateAsync({ type: "blob" }).then(function (content) {
                        saveAs(content, desc + ".zip"); // zipåŒ…å‘½åå¹¶ä¸‹è½½
                    });
                } else {
                    downloadZip();
                }
            }, 100);
        };
        downloadZip();
    };
</script>
<script>
    $("#get").click(function(){
        if (!$.cookie('dycookie')){
            alert('è¯·å…ˆå¡«å†™æŠ–éŸ³çš„cookieæ‰å¯ä»¥æ­£å¸¸è§£æä½œå“')
            return 0;
        }
        let url = $('#video_url').val()
        if (!url){
            alert("ç©ºé“¾æ¥");
            return 0;
        }
        let regexp = /((http|https):\/\/([\w\-]+\.)+[\w\-]+(\/[\w\u4e00-\u9fa5\-\.\/?\@\%\!\&=\+\~\:\#\;\,]*)?)/ig;
        // let urlReg = /(http:\/\/|https:\/\/)((\w|=|\?|\.|\/|&|-)+)/g //ç¬¬äºŒç§
        let this_url = url.match(regexp)
        if(this_url === ''){
            alert('è¯·å¡«å†™æ­£ç¡®åˆ†äº«é“¾æ¥æˆ–å†…å®¹');
            return 0;
        }
        window.location.href = "/api?url=" + this_url;
    });
</script>
<script>

    $("#savecookie").click(function(){
        const dycookie = {
            odin_tt:$('#odin_tt_Field').val(),
            passport_csrf_token: $('#passport_csrf_token_Field').val(),
            sessionid_ss: $('#sessionid_ss_Field').val(),
            ttwid: $('#ttwid_Field').val(),
            msToken: $('#msToken_Field').val(),
        };
        //var cookie = 'dycookie' + "=" + JSON.stringify(dycookie) + '; max-age=' + 30 * 24 * 60 * 60;
        try {
            $.cookie('dycookie', JSON.stringify(dycookie), { expires: 30 });
            //document.cookie = cookie;
            //localStorage.setItem("dycookie", JSON.stringify(dycookie));
            alert('ä¿å­˜æˆåŠŸ')
            $('#cookieform').hide();
        } catch {
            alert('ä¿å­˜å¤±è´¥')
            $('#cookieform').hide();
        }
    });
    $("#cleancookie").click(function(){
        try {
            $.removeCookie('dycookie',{ path: '/'});
            $('#odin_tt_Field').val('')
            $('#passport_csrf_token_Field').val('')
            $('#sessionid_ss_Field').val('')
            $('#ttwid_Field').val('')
            $('#msToken_Field').val('')
            //localStorage.removeItem("dycookie");
            alert('æ¸…ç†æˆåŠŸ')
            $('#cookieform').hide();
        } catch (error) {
            alert('æ¸…ç†å¤±è´¥')
            console.log(error)
            $('#cookieform').hide();
        }
    });
    </script>
    <script src="../static/javascripts/progress.js"></script>
</body>
</html>